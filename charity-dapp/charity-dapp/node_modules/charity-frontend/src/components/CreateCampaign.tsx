import React, { useState } from 'react';
import { useWalletConnection, useTransactionExecution } from '../hooks/useSui';
import { createCampaignTx } from '../utils/suiTransactions';
import './CreateCampaign.css';

const CreateCampaign: React.FC = () => {
  const { account, isConnected, connect } = useWalletConnection();
  const { executeTransaction } = useTransactionExecution();
  
  const [title, setTitle] = useState('');
  const [description, setDescription] = useState('');
  const [goalAmount, setGoalAmount] = useState('');
  const [deadline, setDeadline] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState('');

  // TODO: Replace with actual platform ID after deployment
  const platformId = '0xdd7e02bdc86f3acc2c9777d37835cfe4c597d030a526993138815f6cdfd28a96'; // Placeholder

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    if (!isConnected) {
      connect();
      return;
    }

    if (!title || !description || !goalAmount || !deadline) {
      setError('Vui lÃ²ng Ä‘iá»n táº¥t cáº£ cÃ¡c trÆ°á»ng');
      return;
    }

    try {
      setLoading(true);
      setError('');
      setSuccess('');

      // Convert deadline from date string to Unix timestamp (seconds)
      const deadlineDate = new Date(deadline);
      const deadlineTimestamp = Math.floor(deadlineDate.getTime() / 1000);

      // Convert goal amount from SUI to MIST (1 SUI = 10^9 MIST)
      const goalAmountMIST = BigInt(goalAmount) * BigInt(10 ** 9);

      // Sui Clock object ID (standard on all Sui networks)
      const clockId = '0x6';

      const tx = await createCampaignTx(
        platformId,
        title,
        description,
        Number(goalAmountMIST),
        deadlineTimestamp,
        clockId
      );

      const result = await executeTransaction(tx);

      setSuccess(`âœ… Chiáº¿n dá»‹ch Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng! TX: ${(result as any).digest}`);
      
      // Reset form
      setTitle('');
      setDescription('');
      setGoalAmount('');
      setDeadline('');

    } catch (err: any) {
      setError(`âŒ Lá»—i: ${err.message || 'KhÃ´ng thá»ƒ táº¡o chiáº¿n dá»‹ch'}`);
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="create-campaign-form">
      <h2>ğŸš€ Táº¡o Chiáº¿n Dá»‹ch Tá»« Thiá»‡n</h2>
      
      {!isConnected && (
        <div className="warning-box">
          <p>âš ï¸ Vui lÃ²ng káº¿t ná»‘i vÃ­ Sui cá»§a báº¡n Ä‘á»ƒ táº¡o chiáº¿n dá»‹ch</p>
        </div>
      )}

      {error && <div className="error-box">{error}</div>}
      {success && <div className="success-box">{success}</div>}

      <form onSubmit={handleSubmit}>
        <div className="form-group">
          <label htmlFor="title">ğŸ“ TÃªn Chiáº¿n Dá»‹ch</label>
          <input
            id="title"
            type="text"
            placeholder="Nháº­p tÃªn chiáº¿n dá»‹ch"
            value={title}
            onChange={(e) => setTitle(e.target.value)}
            disabled={!isConnected || loading}
            required
          />
        </div>

        <div className="form-group">
          <label htmlFor="description">ğŸ“„ MÃ´ Táº£</label>
          <textarea
            id="description"
            placeholder="MÃ´ táº£ chi tiáº¿t chiáº¿n dá»‹ch cá»§a báº¡n"
            value={description}
            onChange={(e) => setDescription(e.target.value)}
            disabled={!isConnected || loading}
            rows={5}
            required
          />
        </div>

        <div className="form-row">
          <div className="form-group">
            <label htmlFor="goalAmount">ğŸ’° Má»¥c TiÃªu QuyÃªn GÃ³p (SUI)</label>
            <input
              id="goalAmount"
              type="number"
              placeholder="VÃ­ dá»¥: 100"
              step="0.01"
              value={goalAmount}
              onChange={(e) => setGoalAmount(e.target.value)}
              disabled={!isConnected || loading}
              required
            />
          </div>

          <div className="form-group">
            <label htmlFor="deadline">ğŸ“… Thá»i Háº¡n Chiáº¿n Dá»‹ch</label>
            <input
              id="deadline"
              type="datetime-local"
              value={deadline}
              onChange={(e) => setDeadline(e.target.value)}
              disabled={!isConnected || loading}
              required
            />
          </div>
        </div>

        <button
          type="submit"
          className="btn-submit"
          disabled={!isConnected || loading}
        >
          {loading ? 'â³ Äang xá»­ lÃ½...' : 'âœ¨ Táº¡o Chiáº¿n Dá»‹ch'}
        </button>
      </form>

      <div className="info-box">
        <h4>â„¹ï¸ ThÃ´ng Tin</h4>
        <ul>
          <li>âœ“ Má»¥c tiÃªu quyÃªn gÃ³p lÃ  báº¯t buá»™c</li>
          <li>âœ“ Chá»‰ owner cÃ³ thá»ƒ rÃºt tiá»n khi Ä‘áº¡t má»¥c tiÃªu</li>
          <li>âœ“ CÃ³ thá»ƒ há»§y chiáº¿n dá»‹ch báº¥t ká»³ lÃºc nÃ o</li>
          <li>âœ“ NgÆ°á»i quyÃªn gÃ³p sáº½ nháº­n Ä‘Æ°á»£c biÃªn lai</li>
        </ul>
      </div>
    </div>
  );
};

export default CreateCampaign;
